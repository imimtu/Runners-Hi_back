name: í†µí•© CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: lsheon0927/runapp

jobs:
  build:
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
        run: |
          echo "### ðŸš€ ë¹Œë“œ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "- **ë°°í¬ ëŒ€ìƒ**: âœ… Production í™˜ê²½" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ë°°í¬ ëŒ€ìƒ**: âŒ ë¹Œë“œë§Œ ìˆ˜í–‰" >> $GITHUB_STEP_SUMMARY
          fi

  deploy:
    name: ìš´ì˜ í™˜ê²½ ë°°í¬
    runs-on: ubuntu-latest
    needs: build

    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production

    steps:
      - name: ì„œë²„ ë°°í¬
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 300s
          command_timeout: 600s
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            CURRENT_IMAGE=$(docker inspect running-app --format='{{.Config.Image}}' 2>/dev/null || echo "none")
            echo "$CURRENT_IMAGE" > .last-deployed-image
            
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login --username "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
            
            if ! docker pull ${{ env.DOCKER_IMAGE }}:latest; then
              echo "âŒ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
              exit 1
            fi
            
            docker-compose -f docker-compose-fixed.yml down
            docker-compose -f docker-compose-fixed.yml up -d
            
            for i in {1..30}; do
              if curl -f -s http://localhost:${{ secrets.HEALTH_CHECK_PORT }}/health > /dev/null; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                break
              elif [ $i -eq 30 ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°± ì‹œìž‘"
                if [ "$CURRENT_IMAGE" != "none" ]; then
                  docker tag $CURRENT_IMAGE ${{ env.DOCKER_IMAGE }}:rollback
                  docker-compose -f docker-compose-fixed.yml down
                  sed -i 's|${{ env.DOCKER_IMAGE }}:latest|${{ env.DOCKER_IMAGE }}:rollback|g' docker-compose-fixed.yml
                  docker-compose -f docker-compose-fixed.yml up -d
                  sleep 10
                  if curl -f -s http://localhost:${{ secrets.HEALTH_CHECK_PORT }}/health > /dev/null; then
                    echo "âœ… ë¡¤ë°± ì„±ê³µ"
                  else
                    echo "âŒ ë¡¤ë°±ë„ ì‹¤íŒ¨"
                  fi
                  sed -i 's|${{ env.DOCKER_IMAGE }}:rollback|${{ env.DOCKER_IMAGE }}:latest|g' docker-compose-fixed.yml
                fi
                exit 1
              else
                sleep 2
              fi
            done
            
            docker ps | grep running-app
            docker image prune -f

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "### ðŸŽ‰ ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "### âŒ ë°°í¬ ì‹¤íŒ¨!" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY