# í…ŒìŠ¤íŠ¸ìš© ì£¼ì„ì²˜ë¦¬
#name: ê°„ì†Œí™”ëœ CI/CD íŒŒì´í”„ë¼ì¸
#
#on:
#  push:
#    branches: [develop, main]
#  pull_request:
#    branches: [main]
#
#env:
#  DOCKER_IMAGE: lsheon0927/runapp
#
#jobs:
#  build:
#    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
#        uses: actions/checkout@v4
#
#      - name: Java 17 ì„¤ì •
#        uses: actions/setup-java@v4
#        with:
#          java-version: '17'
#          distribution: 'temurin'
#
#      - name: Gradle ìºì‹œ ì„¤ì •
#        uses: actions/cache@v3
#        with:
#          path: |
#            ~/.gradle/caches
#            ~/.gradle/wrapper
#          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
#          restore-keys: |
#            ${{ runner.os }}-gradle-
#
#      - name: Docker Hub ë¡œê·¸ì¸
#        uses: docker/login-action@v3
#        with:
#          username: ${{ secrets.DOCKER_HUB_USERNAME }}
#          password: ${{ secrets.DOCKER_HUB_TOKEN }}
#
#      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
#        uses: docker/build-push-action@v5
#        with:
#          context: .
#          push: true
#          tags: |
#            ${{ env.DOCKER_IMAGE }}:latest
#            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
#
#  deploy:
#    name: ì„œë²„ ë°°í¬
#    runs-on: ubuntu-latest
#    needs: build
#    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
#
#    steps:
#      - name: ì„œë²„ ë°°í¬
#        uses: appleboy/ssh-action@v1.0.0
#        with:
#          host: ${{ secrets.SERVER_HOST }}
#          username: ${{ secrets.SERVER_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          port: ${{ secrets.SSH_PORT }}
#          timeout: 300s
#          command_timeout: 600s
#          script: |
#            echo "ğŸš€ ë°°í¬ ì‹œì‘"
#            cd ${{ secrets.PROJECT_PATH }}
#
#            # Docker ë¡œê·¸ì¸
#            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login --username "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
#
#            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
#            docker pull ${{ env.DOCKER_IMAGE }}:latest
#
#            # ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
#            docker-compose -f docker-compose-fixed.yml down
#            docker-compose -f docker-compose-fixed.yml up -d
#
#            # í—¬ìŠ¤ì²´í¬ (30ì´ˆ)
#            echo "í—¬ìŠ¤ì²´í¬ ì¤‘..."
#            for i in {1..15}; do
#              if curl -f -s http://localhost:8100/health >/dev/null 2>&1; then
#                echo "âœ… ë°°í¬ ì„±ê³µ!"
#                break
#              elif [ $i -eq 15 ]; then
#                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
#                exit 1
#              else
#                sleep 2
#              fi
#            done
#
#            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"