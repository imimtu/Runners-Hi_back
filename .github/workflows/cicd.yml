name: ëª¨ë‹ˆí„°ë§ ì—°ë™ CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: lsheon0927/runapp

jobs:
  build:
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
        run: |
          echo "### ðŸš€ ë¹Œë“œ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "- **ë°°í¬ ëŒ€ìƒ**: âœ… Production í™˜ê²½" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ë°°í¬ ëŒ€ìƒ**: âŒ ë¹Œë“œë§Œ ìˆ˜í–‰" >> $GITHUB_STEP_SUMMARY
          fi

  deploy:
    name: ìš´ì˜ í™˜ê²½ ë°°í¬
    runs-on: ubuntu-latest
    needs: build

    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production

    steps:
      - name: ì„œë²„ ë°°í¬ ë° ëª¨ë‹ˆí„°ë§ ì—°ë™
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 300s
          command_timeout: 600s
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
            
            echo "ðŸš€ ë°°í¬ ì‹œìž‘: $(date)"
            cd ${{ secrets.PROJECT_PATH }}
            
            # ============================================
            # 1ë‹¨ê³„: ë°°í¬ ì „ ëª¨ë‹ˆí„°ë§ ìƒíƒœ í™•ì¸
            # ============================================
            echo "ðŸ“Š ë°°í¬ ì „ ëª¨ë‹ˆí„°ë§ ìƒíƒœ í™•ì¸ ì¤‘..."
            
            # Prometheus ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if ! curl -f -s http://localhost:9090/-/healthy >/dev/null 2>&1; then
              echo "âŒ Prometheus ì„œë¹„ìŠ¤ê°€ ë¹„ì •ìƒìž…ë‹ˆë‹¤"
              exit 1
            fi
            echo "âœ… Prometheus ì„œë¹„ìŠ¤ ì •ìƒ"
            
            # í˜„ìž¬ Spring Boot íƒ€ê²Ÿ ìƒíƒœ í™•ì¸
            CURRENT_TARGET_STATUS=$(curl -s http://localhost:9090/api/v1/targets | jq -r '.data.activeTargets[] | select(.labels.job=="spring-boot-app") | .health' 2>/dev/null || echo "unknown")
            echo "í˜„ìž¬ Spring Boot íƒ€ê²Ÿ ìƒíƒœ: $CURRENT_TARGET_STATUS"
            
            # ============================================
            # 2ë‹¨ê³„: í˜„ìž¬ ì´ë¯¸ì§€ ë°±ì—… ë° ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            # ============================================
            CURRENT_IMAGE=$(docker inspect running-app --format='{{.Config.Image}}' 2>/dev/null || echo "none")
            echo "í˜„ìž¬ ì´ë¯¸ì§€: $CURRENT_IMAGE"
            echo "$CURRENT_IMAGE" > .last-deployed-image
            
            echo "ðŸ” Docker Hub ë¡œê·¸ì¸..."
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login --username "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
            
            echo "ðŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            if ! docker pull ${{ env.DOCKER_IMAGE }}:latest; then
              echo "âŒ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
              exit 1
            fi
            
            # ============================================
            # 3ë‹¨ê³„: ì»¨í…Œì´ë„ˆ ìž¬ì‹œìž‘
            # ============================================
            echo "ðŸ”„ ì»¨í…Œì´ë„ˆ ìž¬ì‹œìž‘ ì¤‘..."
            docker-compose -f docker-compose-fixed.yml down
            
            # 5ì´ˆ ëŒ€ê¸° (ì™„ì „í•œ ì¢…ë£Œ ë³´ìž¥)
            sleep 5
            
            docker-compose -f docker-compose-fixed.yml up -d
            
            # ============================================
            # 4ë‹¨ê³„: ê°•í™”ëœ í—¬ìŠ¤ì²´í¬ (3ë‹¨ê³„ ê²€ì¦)
            # ============================================
            echo "ðŸ¥ ê°•í™”ëœ í—¬ìŠ¤ì²´í¬ ì‹œìž‘..."
            
            # 4-1. ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ (60ì´ˆ)
            echo "  â”” 1ë‹¨ê³„: ê¸°ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬..."
            for i in {1..30}; do
              if curl -f -s http://localhost:8100/health >/dev/null 2>&1; then
                echo "  âœ… ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (${i}*2ì´ˆ í›„)"
                break
              elif [ $i -eq 30 ]; then
                echo "  âŒ ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                goto_rollback=true
                break
              else
                echo -n "."
                sleep 2
              fi
            done
            
            # 4-2. Prometheus ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ (30ì´ˆ)
            if [ "$goto_rollback" != "true" ]; then
              echo "  â”” 2ë‹¨ê³„: Prometheus ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸..."
              for i in {1..15}; do
                if curl -f -s http://localhost:8100/actuator/prometheus | grep -q "application_ready_time_seconds"; then
                  echo "  âœ… Prometheus ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ ì •ìƒ (${i}*2ì´ˆ í›„)"
                  break
                elif [ $i -eq 15 ]; then
                  echo "  âŒ Prometheus ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨"
                  goto_rollback=true
                  break
                else
                  echo -n "."
                  sleep 2
                fi
              done
            fi
            
            # 4-3. Prometheus íƒ€ê²Ÿ ë“±ë¡ í™•ì¸ (60ì´ˆ)
            if [ "$goto_rollback" != "true" ]; then
              echo "  â”” 3ë‹¨ê³„: Prometheus íƒ€ê²Ÿ ë“±ë¡ í™•ì¸..."
              for i in {1..30}; do
                TARGET_STATUS=$(curl -s http://localhost:9090/api/v1/targets | jq -r '.data.activeTargets[] | select(.labels.job=="spring-boot-app") | .health' 2>/dev/null || echo "unknown")
                if [ "$TARGET_STATUS" = "up" ]; then
                  echo "  âœ… Prometheus íƒ€ê²Ÿ ë“±ë¡ ì„±ê³µ (${i}*2ì´ˆ í›„)"
                  break
                elif [ $i -eq 30 ]; then
                  echo "  âŒ Prometheus íƒ€ê²Ÿ ë“±ë¡ ì‹¤íŒ¨ (ìƒíƒœ: $TARGET_STATUS)"
                  goto_rollback=true
                  break
                else
                  echo -n "."
                  sleep 2
                fi
              done
            fi
            
            # ============================================
            # 5ë‹¨ê³„: ë¡¤ë°± ì²˜ë¦¬ (ëª¨ë‹ˆí„°ë§ í¬í•¨)
            # ============================================
            if [ "$goto_rollback" = "true" ]; then
              echo "ðŸ”™ ë¡¤ë°± ì‹œìž‘..."
            
              if [ "$CURRENT_IMAGE" != "none" ]; then
                echo "  â”” ì´ì „ ì´ë¯¸ì§€ë¡œ ë¡¤ë°±: $CURRENT_IMAGE"
                docker tag $CURRENT_IMAGE ${{ env.DOCKER_IMAGE }}:rollback
                docker-compose -f docker-compose-fixed.yml down
            
                # docker-compose íŒŒì¼ì—ì„œ ì´ë¯¸ì§€ íƒœê·¸ ìž„ì‹œ ë³€ê²½
                sed -i 's|${{ env.DOCKER_IMAGE }}:latest|${{ env.DOCKER_IMAGE }}:rollback|g' docker-compose-fixed.yml
                docker-compose -f docker-compose-fixed.yml up -d
            
                # ë¡¤ë°± í›„ í—¬ìŠ¤ì²´í¬
                sleep 10
                if curl -f -s http://localhost:8100/health >/dev/null 2>&1; then
                  echo "  âœ… ë¡¤ë°± ì„±ê³µ"
            
                  # ë¡¤ë°± í›„ ëª¨ë‹ˆí„°ë§ ìƒíƒœ í™•ì¸
                  sleep 10
                  ROLLBACK_TARGET_STATUS=$(curl -s http://localhost:9090/api/v1/targets | jq -r '.data.activeTargets[] | select(.labels.job=="spring-boot-app") | .health' 2>/dev/null || echo "unknown")
                  echo "  â”” ë¡¤ë°± í›„ ëª¨ë‹ˆí„°ë§ ìƒíƒœ: $ROLLBACK_TARGET_STATUS"
                else
                  echo "  âŒ ë¡¤ë°±ë„ ì‹¤íŒ¨"
                fi
            
                # docker-compose íŒŒì¼ ì›ë³µ
                sed -i 's|${{ env.DOCKER_IMAGE }}:rollback|${{ env.DOCKER_IMAGE }}:latest|g' docker-compose-fixed.yml
              else
                echo "  â”” ì´ì „ ì´ë¯¸ì§€ê°€ ì—†ì–´ ë¡¤ë°± ë¶ˆê°€"
              fi
            
              exit 1
            fi
            
            # ============================================
            # 6ë‹¨ê³„: ë°°í¬ ì™„ë£Œ ë° ìƒíƒœ í™•ì¸
            # ============================================
            echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ: $(date)"
            echo ""
            echo "ðŸ“Š ìµœì¢… ìƒíƒœ í™•ì¸:"
            echo "  â”” ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps | grep running-app
            echo ""
            echo "  â”” ëª¨ë‹ˆí„°ë§ ìƒíƒœ:"
            FINAL_TARGET_STATUS=$(curl -s http://localhost:9090/api/v1/targets | jq -r '.data.activeTargets[] | select(.labels.job=="spring-boot-app") | .health' 2>/dev/null || echo "unknown")
            echo "    - Prometheus íƒ€ê²Ÿ ìƒíƒœ: $FINAL_TARGET_STATUS"
            
            # ë©”íŠ¸ë¦­ ìƒ˜í”Œ í™•ì¸
            METRIC_COUNT=$(curl -s http://localhost:8100/actuator/prometheus | wc -l 2>/dev/null || echo "0")
            echo "    - ìˆ˜ì§‘ ì¤‘ì¸ ë©”íŠ¸ë¦­ ë¼ì¸ ìˆ˜: $METRIC_COUNT"
            
            echo ""
            echo "ðŸ§¹ ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f
            
            echo "âœ¨ ëª¨ë“  ë°°í¬ ê³¼ì • ì™„ë£Œ!"

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "### ðŸŽ‰ ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ëª¨ë‹ˆí„°ë§**: âœ… Prometheus ì—°ë™ í™•ì¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://58.226.77.91:8100" >> $GITHUB_STEP_SUMMARY
          echo "- **Grafana**: http://58.226.77.91:3000" >> $GITHUB_STEP_SUMMARY

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "### âŒ ë°°í¬ ì‹¤íŒ¨!" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì¡°ì¹˜**: ìžë™ ë¡¤ë°± ì‹œë„ë¨" >> $GITHUB_STEP_SUMMARY
          echo "- **í™•ì¸ì‚¬í•­**: ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€ í•„ìš”" >> $GITHUB_STEP_SUMMARY