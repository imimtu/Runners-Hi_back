name: VPN ì—°ê²° CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: lsheon0927/runapp

jobs:
  build:
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}

  deploy:
    name: VPN ì—°ê²° í›„ ì„œë²„ ë°°í¬
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      # 1. WireGuard ì„¤ì¹˜
      - name: WireGuard ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools

      # 2. WireGuard ì„¤ì • íŒŒì¼ ìƒì„±
      - name: WireGuard ì„¤ì • íŒŒì¼ ìƒì„±
        run: |
          echo "${{ secrets.WG_CONFIG }}" | sudo tee /etc/wireguard/github-client.conf
          sudo chmod 600 /etc/wireguard/github-client.conf

      # 3. WireGuard ì—°ê²°
      - name: WireGuard ì—°ê²° ì‹œì‘
        run: |
          sudo wg-quick up github-client
          sleep 10

      # 4. VPN ì—°ê²° í™•ì¸
      - name: VPN ì—°ê²° ìƒíƒœ í™•ì¸
        timeout-minutes: 2
        run: |
          # WireGuard ìƒíƒœ í™•ì¸
          sudo wg show
          
          # VPN ë‚´ë¶€ IPë¡œ ì„œë²„ ì—°ê²° í™•ì¸ (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
          echo "SSH í¬íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸..."
          for i in {1..30}; do
            if nc -z -w 3 10.8.0.1 22; then
              echo "âœ… SSH í¬íŠ¸ ì—°ê²° ì„±ê³µ!"
              break
            elif timeout 3 ping -c1 10.8.0.1 >/dev/null 2>&1; then
              echo "âœ… Ping ì—°ê²° ì„±ê³µ!"
              break
            elif [ $i -eq 30 ]; then
              echo "âŒ VPN ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
              echo "ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸:"
              ip route show
              echo "ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ í™•ì¸:"
              ip addr show github-client
              exit 1
            else
              echo "ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘... (${i}/30)"
              sleep 2
            fi
          done

      # 5. ì„œë²„ ë°°í¬ (VPN ë‚´ë¶€ IP ì‚¬ìš©)
      - name: ì„œë²„ ë°°í¬
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 10.8.0.1  # VPN ë‚´ë¶€ IP ì‚¬ìš©
          username: github-deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22  # ì¼ë°˜ SSH í¬íŠ¸ (VPN ë‚´ë¶€)
          timeout: 300s
          command_timeout: 600s
          script: |
            echo "ğŸš€ VPNì„ í†µí•œ ë°°í¬ ì‹œì‘"
            cd /home/lsheon0927/running-app
            
            # Docker ë¡œê·¸ì¸
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login --username "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
            
            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            docker-compose -f docker-compose-fixed.yml down
            docker-compose -f docker-compose-fixed.yml up -d
            
            # í—¬ìŠ¤ì²´í¬
            echo "í—¬ìŠ¤ì²´í¬ ì¤‘..."
            for i in {1..15}; do
              if curl -f -s http://localhost:8100/health >/dev/null 2>&1; then
                echo "âœ… ë°°í¬ ì„±ê³µ!"
                break
              elif [ $i -eq 15 ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                exit 1
              else
                sleep 2
              fi
            done

      # 6. WireGuard ì—°ê²° í•´ì œ
      - name: WireGuard ì—°ê²° í•´ì œ
        if: always()
        run: |
          sudo wg-quick down github-client || true
          sudo rm -f /etc/wireguard/github-client.conf

      # 7. WireGuard ë¡œê·¸ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: WireGuard ìƒíƒœ ë¡œê·¸
        if: always()
        run: |
          echo "=== WireGuard ìµœì¢… ìƒíƒœ ==="
          sudo wg show || true
          echo "=== ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ==="
          ip addr show | grep -E "(wg|10\.8\.)" || true